<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Crossfilter - Initial Footy Testing</title>
	
	<!-- All of this is essential for DC.js -->
	<meta http-equiv="content-type" content="text/html; charset=UTF8">
	<script type='text/javascript' src='https://d3js.org/d3.v3.js'></script>
 	<script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
 	<script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.4/dc.js"></script>
 	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.4/dc.css">


	<link rel="stylesheet" href="lib/css/bootstrap.min.css">
    <link rel="stylesheet" href="lib/css/keen-dashboards.css">
    <link rel="stylesheet" href="lib/css/dc.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="lib/css/introjs.css"/>
	
<style type="text/css">
	

</style>

</head>
<body>

<body class="application">
  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="./">School Donations Dashboard</a>
        </div>
      
        <div class = "nav navbar-nav navbar-right">
          <button class="btn btn-danger btn-xs btn-padding" role="button" autofocus onclick="javascript:introJs().start();">Start Tour!</button>
       </div>
     </div>
  </div>
<div class = "container">
	
		<div class="row">
			
			<!-- This is the anchor point for the chart in the page-->
			<div id="chart-line-transfer"></div>

		</div>

		<div class="row">

			<div id="chart-ring-year"></div>

			<div  style="margin: 15px"  id="chart-ring-year2"></div>
	
			<div id="chart-ring-year3"></div>
		</div>
</div>

<script>

	//helper function to print out filter
	function print_filter(filter){
		var f=eval(filter);
		if (typeof(f.length) != "undefined") {}else{}
		if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
		if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
		console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
	}


var footyData = [
	  {
    "season": "20102011",
    "transfer_window": "Summer",
    "player_name": "Andrew Carroll",
    "league_moving_from": "Premier",
    "club_moving_from": "Newcastle United",
    "league_moving_to": "Premier",
    "club_moving_to": "Liverpool",
    "fee": 35000000,
    "date": "31/01/2011"
  },
  {
    "season": "20102011",
    "transfer_window": "Winter",
    "player_name": "Conor Sammon",
    "league_moving_from": "NonEPLChamp",
    "club_moving_from": "Kilmarnock",
    "league_moving_to": "Premier",
    "club_moving_to": "Wigan Athletic",
    "fee": 6000000,
    "date": "28/01/2011"
  },
  {
    "season": "20112012",
    "transfer_window": "Winter",
    "player_name": "David Ball",
    "league_moving_from": "Premier",
    "club_moving_from": "Manchester City",
    "league_moving_to": "NonEPLChamp",
    "club_moving_to": "Chelsea",
    "fee": "20000000",
    "date": "31/01/2012"
  },
  {
    "season": "20112012",
    "transfer_window": "Summer",
    "player_name": "David Luiz",
    "league_moving_from": "NonEPLChamp",
    "club_moving_from": "Benfica",
    "league_moving_to": "Premier",
    "club_moving_to": "Chelsea",
    "fee": 21300000,
    "date": "16/07/2011"
  },
  {
    "season": "20122013",
    "transfer_window": "Winter",
    "player_name": "Fernando Torres",
    "league_moving_from": "Premier",
    "club_moving_from": "Liverpool",
    "league_moving_to": "Premier",
    "club_moving_to": "Aldershot",
    "fee": 50000000,
    "date": "31/01/2013"
  }];



	//creating a cross filter instance
	var ndx = crossfilter(footyData);
		//print_filter("footyData");		

	


	//Get dates in a state they will be recognised as dates
	var parseDate = d3.time.format("%d/%m/%Y").parse;
		footyData.forEach(function(d) {
		d.date = parseDate(d.date);
		d.Year = d.date.getFullYear();
	});


	// Getting all required Dimensions
	//Club Moving TO Dim
//	var seasonDim = ndx.dimension(function(d) {return d.season;});
	//Transfer Window
	var transfer_windowDim = ndx.dimension(function(d) {return d.transfer_window;});
	//League Moving FROM Dim
	var league_moving_fromDim = ndx.dimension(function(d) {return d.league_moving_from;});
	//Club Moving FROM Dim
	var club_moving_fromDim = ndx.dimension(function(d) {return d.club_moving_from;});
	//League Moving TO Dim
	var club_moving_toDim = ndx.dimension(function(d) {return d.club_moving_to;});
	//Club Moving To Dim
	var club_moving_toDim = ndx.dimension(function(d) {return d.club_moving_to;});
	//Fee
	var feeDim = ndx.dimension(function(d) {return d.fee;});	
	//Use crossfilter to get views of the data for X axis (date) and Y axis (hits)
	var dateDim = ndx.dimension(function(d) {return d.date;});
	//Groups total for each club for range in data
	
	//print_filter("dateDim");	


	var feeDateDim_filter = dateDim.group().reduceSum(function(d) {return d.fee/1000;});
	//Groups total for each club for range in data
	//print_filter("feeDateDim_filter");	


	/*
	var transferCost_filter = club_moving_toDim.group().reduceSum(function (d) {
		if (d.transfer_window == "Summer" || d.transfer_window == "Winter"){
   			return d.fee;			
		}
		else{
			return 0;	
		}
	});
	*/

	//Getting max and min values for time based chart
	var minDate = dateDim.bottom(1)[0].date;
    var maxDate = dateDim.top(1)[0].date;

   	//Charts
   	var chartTransfer = dc.lineChart("#chart-line-transfer");
	//var chartTransfer = dc.scatterPlot("#chart-line-transfer");
	chartTransfer
       .width(800)
       .height(200)
       .margins({top: 10, right: 50, bottom: 30, left: 50})
       .dimension(dateDim)
       .group(feeDateDim_filter)
       .transitionDuration(500)
       .x(d3.time.scale().domain([minDate, maxDate]))
       .elasticY(true)
       .yAxisLabel("Amount Spent (Â£'s)")
       .xAxisLabel("Year")
       .yAxis().ticks(4);


	var yearDim  = ndx.dimension(function(d) {return +d.Year;});
	var year_total = yearDim.group().reduceSum(function(d) {return d.fee;});
	
	//Associate chart with HTML element
	var hitspieChart = dc.pieChart("#chart-ring-year");
	//criteria for pie chart
	hitspieChart
		.width(190)
		.height(190)
		.slicesCap(4)
		.innerRadius(50)
   		.dimension(yearDim)
   		.group(year_total);


	var seasonDim  = ndx.dimension(function(d) {return +d.season;});
	//print_filter("seasonDim");	
	var season_total = seasonDim.group().reduceSum(function(d) {return d.season;});
	//print_filter("season_total");	
	
	//Associate chart with HTML element
	var hitspieChart2 = dc.pieChart("#chart-ring-year2");
	//criteria for pie chart
	hitspieChart2
		.width(190)
		.height(190)
		.slicesCap(4)
		.innerRadius(50)
   		.dimension(seasonDim)
   		.group(season_total);

   	/*
 	var leagueDim = d3.nest()
 	  .key(function(d) { return d.name; })

var expensesCount = d3.nest()
  .key(function(d) { return d.name; })
  .rollup(function(v) { return v.length; })
  .entries(expenses);
console.log(JSON.stringify(expensesCount));


	*/
	

	print_filter("footyData");
	var leagueDim  = ndx.dimension(function(d) {return d.club_moving_to;});
	print_filter("leagueDim");
	var leagueGroup = leagueDim.group().reduceSum(function(d) {return d.fee;});
	print_filter("leagueGroup");	


	
	//Associate chart with HTML element
	var hitspieChart3 = dc.pieChart("#chart-ring-year3");
	//criteria for pie chart
	hitspieChart3
		.width(290)
		.height(290)
		.slicesCap(4)
		.innerRadius(50)
   		.dimension(leagueDim)
   		.group(leagueGroup);




    dc.renderAll();

</script>
</body>
</html>

